<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Confirma√ß√£o de Presen√ßa ‚Äî Baile de M√°scaras</title>
  
  <!-- Apply theme immediately to prevent flash -->
  <script>
    (function(){
      const stored = localStorage.getItem('site-theme');
      const initial = stored || (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      if(initial === 'light') document.documentElement.setAttribute('data-theme', 'light');
    })();
  </script>
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Great+Vibes&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" href="/images/favicon.svg" type="image/svg+xml">
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <h1>Baile de M√°scaras</h1>
      <p class="lead">Comemora√ß√£o aos 30 Anos de <span class="celebrant-name">Thamires Feres</span></p>
    </div>
    <button class="theme-toggle" aria-pressed="false" aria-label="Alternar tema" title="Alternar tema">
      <span class="icon">‚òæ</span>
      <span class="label">Tema</span>
    </button>
    <button class="hamburger" aria-label="Menu" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav class="main-nav" aria-label="Navega√ß√£o principal">
      <a href="/">In√≠cio</a>
      <a href="/pages/convite.html">Convite</a>
      <a href="/pages/codigo-vestes.html">C√≥digo de Vestes</a>
      <a href="/pages/premio.html">Pr√™mio</a>
      <a href="/pages/votacao.html" class="menu-votacao" style="display:none">Vota√ß√£o</a>
      <a href="/pages/confirmacao-simples.html">Confirma√ß√£o</a>
      <a href="/pages/tributos.html">Tributos</a>
    </nav>
  </header>

  <div class="container">
    <section class="card">
      <div class="h-deco">
        <h2>ü™∂ Confirma√ß√£o de Presen√ßa</h2>
        <img src="/images/flourish.svg" alt="ornamento" class="ornament" aria-hidden="true">
      </div>
      
      <p class="lead-para">Para que as acomoda√ß√µes e os festejos estejam √† altura da realeza, solicita-se a confirma√ß√£o de presen√ßa com a maior brevidade poss√≠vel.</p>
      
      <form id="rsvp-form" class="card" style="margin-top:12px">
        <h3 style="color:var(--gold);text-align:center;margin:0 0 24px;font-family:'Playfair Display',serif">üë§ Respons√°vel pela Confirma√ß√£o</h3>
        
        <div class="form-row">
          <label class="small">Nome Completo *<br>
            <input id="nome-responsavel" name="nome" class="input" required placeholder="Ex.: Maria das Flores">
          </label>
          <label class="small">Idade *<br>
            <input type="number" id="idade-responsavel" name="idade" class="input" required placeholder="Ex.: 30" min="1" max="120">
          </label>
        </div>
        
        <div class="form-row" style="margin-top:12px">
          <label class="small">Telefone *<br>
            <input id="telefone-responsavel" name="telefone" class="input" data-mask="telefone" required placeholder="(00) 90000-0000">
          </label>
        </div>

        <!-- Os acompanhantes foram temporariamente desativados para evitar convites n√£o autorizados -->
        <div style="margin-top:32px;border-top:1px solid rgba(212,175,55,0.15);padding-top:24px">
          <p class="note" style="margin-bottom:0">Observa√ß√£o: no momento n√£o √© poss√≠vel adicionar acompanhantes via formul√°rio. Se precisar autorizar acompanhantes, entre em contato com os organizadores.</p>
        </div>

        <!-- Bot√µes -->
        <div style="margin-top:32px;text-align:center">
          <button class="btn primary" type="submit" style="font-size:1.1rem;padding:14px 32px">
            ‚úÖ Confirmar Presen√ßa
          </button>
        </div>
      </form>

      <div id="success-message" style="display:none;margin-top:24px;padding:20px;background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);border-radius:8px;text-align:center">
        <p style="color:#4CAF50;font-size:1.1rem;margin:0">
          ‚úÖ Confirma√ß√£o registrada com sucesso!
        </p>
        <p style="color:var(--muted);font-size:0.9rem;margin:8px 0 0">
          Nos vemos no baile! üé≠‚ú®
        </p>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <p>Feito com esmero para uma noite inesquec√≠vel ‚Äî Inspirado por Bridgerton.</p>
  </footer>

  <!-- main.js REMOVIDO - conflita com o c√≥digo inline de submit deste formul√°rio -->
  <!-- <script src="/js/main.js" defer></script> -->
  <script src="/js/masks-validation.js?v=6"></script>
  <script src="/js/modals.js?v=6"></script>
  <script src="/js/supabase-config.js?v=6"></script>
  <script src="/js/supabase-functions.js?v=6"></script>
  <script src="/js/menu-votacao.js?v=6"></script>
  <script>
    // ========================================
    // TEMA - C√≥digo inline para evitar conflito
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.querySelector('.theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('site-theme', newTheme);
          
          // Atualizar √≠cone
          const icon = themeToggle.querySelector('.icon');
          if (icon) {
            icon.textContent = newTheme === 'dark' ? '‚òæ' : '‚òÄ';
          }
          
          console.log('üé® Tema alterado para:', newTheme);
        });
      }
      
      // Hamburger menu
      const hamburger = document.querySelector('.hamburger');
      const nav = document.querySelector('.main-nav');
      if (hamburger && nav) {
        hamburger.addEventListener('click', () => {
          const isExpanded = hamburger.getAttribute('aria-expanded') === 'true';
          hamburger.setAttribute('aria-expanded', !isExpanded);
          hamburger.classList.toggle('active');
          nav.classList.toggle('active');
        });
      }
    });
    
    // ========================================
    // FORMUL√ÅRIO DE CONFIRMA√á√ÉO
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
      // Verificar se o Supabase foi inicializado
      if (!window.supabase) {
        console.error('‚ùå Supabase n√£o foi inicializado!');
        showError('Erro de Configura√ß√£o', 'O sistema de confirma√ß√£o n√£o est√° dispon√≠vel. Entre em contato com os organizadores.');
        return;
      }

      // A funcionalidade de adicionar acompanhantes foi desativada para evitar convites n√£o autorizados.

    // Submit do formul√°rio
    const formElement = document.getElementById('rsvp-form');
    console.log('üîç Formul√°rio encontrado:', formElement);
    
    formElement.addEventListener('submit', async (e) => {
      console.log('üöÄ Submit capturado ANTES de preventDefault!');
      console.log('üìã Form data IMEDIATA:', new FormData(e.target));
      console.log('üìã Form elements:', e.target.elements);
      
      // Capturar valores ANTES de preventDefault
      const valorNome = e.target.elements['nome'].value;
      const valorIdade = e.target.elements['idade'].value;
      const valorTelefone = e.target.elements['telefone'].value;
      
      console.log('‚úÖ Valores ANTES do preventDefault:', {
        nome: valorNome,
        idade: valorIdade,
        telefone: valorTelefone
      });
      
      e.preventDefault();
      e.stopImmediatePropagation();
      
      console.log('üöÄ Submit capturado DEPOIS de preventDefault!');
      
      const nomeInput = document.getElementById('nome-responsavel');
      const idadeInput = document.getElementById('idade-responsavel');
      const telefoneInput = document.getElementById('telefone-responsavel');
      
      console.log('üîç Inputs encontrados:', {
        nomeInput,
        idadeInput,
        telefoneInput
      });
      
      console.log('üîç Valores RAW dos inputs:', {
        nomeValue: nomeInput.value,
        idadeValue: idadeInput.value,
        telefoneValue: telefoneInput.value
      });
      
      const nomeResponsavel = nomeInput.value.trim();
      const idadeResponsavel = parseInt(idadeInput.value);
      const telefone = telefoneInput.value.trim();
      
      // Debug
      console.log('üìù Dados do formul√°rio:', {
        nome: nomeResponsavel,
        idade: idadeResponsavel,
        telefone: telefone
      });
      
      // Valida√ß√£o b√°sica com feedback visual
      if (!nomeResponsavel) {
        nomeInput.style.borderColor = '#f44336';
        nomeInput.focus();
        showError('Nome Obrigat√≥rio', 'Por favor, preencha seu nome completo.');
        return;
      } else {
        nomeInput.style.borderColor = '';
      }
      
      if (!idadeResponsavel || isNaN(idadeResponsavel)) {
        idadeInput.style.borderColor = '#f44336';
        idadeInput.focus();
        showError('Idade Obrigat√≥ria', 'Por favor, preencha sua idade.');
        return;
      } else {
        idadeInput.style.borderColor = '';
      }
      
      if (!telefone) {
        telefoneInput.style.borderColor = '#f44336';
        telefoneInput.focus();
        showError('Telefone Obrigat√≥rio', 'Por favor, preencha seu telefone.');
        return;
      } else {
        telefoneInput.style.borderColor = '';
      }
      
      // Validar telefone
      if (!validarTelefone(telefone)) {
        telefoneInput.style.borderColor = '#f44336';
        telefoneInput.focus();
        showError('Telefone Inv√°lido', 'Por favor, digite um telefone v√°lido no formato (00) 00000-0000');
        return;
      }
      
      // Desabilitar bot√£o e mostrar loading
      const submitBtn = formElement.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '‚è≥ Enviando...';
      submitBtn.style.opacity = '0.7';
      
      // Coletar dependentes
      const depCards = document.querySelectorAll('#dependentes-list > div');
      const dependentesData = [];
      
      for (const card of depCards) {
        const nome = card.querySelector('.dep-nome').value.trim();
        const idade = parseInt(card.querySelector('.dep-idade').value);
        
        if (!nome || !idade) {
          showError('Dados Incompletos', 'Por favor, preencha nome e idade de todos os acompanhantes.');
          return;
        }
        
        dependentesData.push({ nome, idade });
      }
      
      // Preparar dados
      const dados = {
        nome: nomeResponsavel,
        idade: idadeResponsavel,
        telefone: telefone,
        dependentes: dependentesData
      };
      
      console.log('üì§ Enviando confirma√ß√£o:', dados);
      
      showLoading('Salvando sua confirma√ß√£o...');
      
      try {
        // Salvar no Supabase
        const result = await salvarRSVPSimples(dados);
        
        hideLoading();
        
        if (result.error) {
          // Reativar bot√£o em caso de erro
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          submitBtn.style.opacity = '1';
          throw new Error(result.error.message);
        }
        
        // Sucesso!
        showSuccess(
          'Confirma√ß√£o Registrada! üéâ',
          `Obrigado, ${nomeResponsavel}! Sua presen√ßa foi confirmada com sucesso. Aguardamos voc√™ no baile!`,
          'Entendido'
        );
        
        // Esconder formul√°rio e mostrar mensagem de sucesso
        setTimeout(() => {
          document.getElementById('rsvp-form').style.display = 'none';
          document.getElementById('success-message').style.display = 'block';
          document.getElementById('success-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 1500);
        
        console.log('‚úÖ Confirma√ß√£o salva:', result);
        
      } catch (error) {
        hideLoading();
        
        // Reativar bot√£o em caso de erro
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        submitBtn.style.opacity = '1';
        
        console.error('‚ùå Erro ao salvar:', error);
        showError(
          'Erro ao Confirmar',
          `N√£o foi poss√≠vel salvar sua confirma√ß√£o: ${error.message}\n\nVerifique sua conex√£o e tente novamente.`
        );
      }
    });

    // Fun√ß√£o para salvar RSVP simplificado
    async function salvarRSVPSimples(dados) {
      try {
        // 1. Inserir respons√°vel (com idade)
        const { data: rsvp, error: rsvpError } = await supabase
          .from('rsvps')
          .insert({
            nome: dados.nome,
            telefone: dados.telefone,
            idade: dados.idade,
            email: null
          })
          .select()
          .single();
        
        if (rsvpError) throw rsvpError;
        
        console.log('‚úÖ Respons√°vel salvo:', rsvp);
        
        // 2. Inserir dependentes (se houver)
        if (dados.dependentes && dados.dependentes.length > 0) {
          const dependentesInsert = dados.dependentes.map(dep => ({
            rsvp_id: rsvp.id,
            nome: dep.nome,
            idade: dep.idade,
            tipo: dep.idade < 12 ? 'crianca' : 'adulto'
          }));
          
          const { data: deps, error: depsError } = await supabase
            .from('dependentes')
            .insert(dependentesInsert)
            .select();
          
          if (depsError) throw depsError;
          
          console.log('‚úÖ Dependentes salvos:', deps);
        }
        
        return { 
          success: true, 
          rsvp, 
          message: `Confirma√ß√£o registrada! Total: ${1 + (dados.dependentes?.length || 0)} pessoa(s)` 
        };
        
      } catch (error) {
        console.error('‚ùå Erro no Supabase:', error);
        return { error };
      }
    }
    
    }); // Fim do DOMContentLoaded
  </script>
</body>
</html>
